<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="node_modules/@chrisoakman/chessboardjs/dist/chessboard-1.0.0.min.css"
        crossorigin="anonymous">
    <style>
        #boards {
            display: flex;
        }
    </style>
</head>

<body>

    <div class="stepper">
        <select id="opening"></select> <button type="button" id="reset">reset</button>

        <div id="moves"> </div>

        <div id="boards"></div>
    </div>

    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/@chrisoakman/chessboardjs/dist/chessboard-1.0.0.min.js"></script>
    <script>
        player = new class {

            database = [
                { appliesTo: 'white', name: 'Scholars Mate (1)', moves: ['e2-e4', 'e7-e5', 'f1-c4', 'd1-f3', 'f3-f7'] },

                { appliesTo: 'white', name: 'Scholars Mate (2)', moves: ['e2-e4', 'e7-e5', 'f1-c4', 'd1-h5', 'h5-f7'] },
                { appliesTo: 'white', name: 'Tennison Gambit (1)', moves: 'e2-e4 d7-d5 g1-f3 d5-e4 f3-e5 f7-f6 d1-h5 g7-g6 f1-c4 g6-h5 c4-f7'.split(' ') },
                { appliesTo: 'white', name: 'Tennison Gambit (2)', moves: 'e2-e4 d7-d5 g1-f3 d5-e4 f3-g5 g8-f6 d2-d3 e4-d3 f1-d3 h7-h6 g5-f7 e8-f7 d3-g6 f7-g6 d1-d8'.split(' ') },
                { appliesTo: 'white', name: 'Mortimer Trap', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-b5 g8-f6 d2-d3 c6-e7 f3-e5 c7-c6 e5-c4 c6-b5 c4-d6'.split(' ') },

                { appliesTo: 'white', name: 'Italian Game - Fried Liver Attack', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 g8-f6 f3-g5 d7-d5 e4-d5 f6-d5 g5-f7 d8-e7 f7-h8'.split(' '), url: 'https://www.chess.com/openings/Italian-Game-Fried-Liver-Attack', },

                { appliesTo: 'black', name: 'Italian Game - Fried Liver Attack Defense', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 g8-f6 f3-g5 f6-e4 g5-f7 d8-h4 g2-g3 e4-g3 f7-h8 h4-e4 c4-e2 e4-h1 e2-f1 h1-f1'.split(' '), url: 'https://www.youtube.com/watch?v=cN4Xpz5yHSQ' },

                // https://www.youtube.com/watch?v=6ACqk117Q7U&list=PL90OzHiSE_mQcVlOHQ0_niB29icDmDipY&index=2
                { appliesTo: 'white', name: 'Italian Game (1)', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 d7-d6 b1-c3 g8-f6 f3-g5 h7-h6 g5-f7 d8-e7 f7-h8'.split(' ') },
                { appliesTo: 'white', name: 'Italian Game (2)', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 d7-d6 b1-c3 c8-g4 h2-h3 g4-h5 f3-e5 c6-e5 d1-h5 e5-c4 h5-b5 d8-d7 b5-c4'.split(' ') },
                { appliesTo: 'white', name: 'Italian Game - LÃ©gal Trap', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 d7-d6 b1-c3 c8-g4 h2-h3 g4-h5 f3-e5 h5-d1 c4-f7 e8-e7 c3-d5 d5-e7'.split(' ') },
                { appliesTo: 'black', name: 'Italian Game - Blackburne Shilling Gambit', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 c6-d4 f3-e5 d8-g5 e5-f7 g5-g2 f7-h8 g2-h1 c4-f1 h1-e4 f1-e2 d4-c2 e1-f1 e4-h1 h1-f1'.split(' ') },
                { appliesTo: 'white', name: 'Italian Game - Blackburne Shilling Gambit Defense', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 c6-d4 e1-g1&h1-f1 d4-f3 d1-f3 g8-f6 d2-d4 e5-d4 e4-e5 d7-d5 e5-f6 d5-c4 c1-g5 g7-g6 f1-e1 c8-e6 e1-e6 f7-e6 f6-f7 f7-e8'.split(' ') },
                { appliesTo: 'white', name: 'Italian Game - Rousseau Gambit', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 f7-f5 e4-f5 e5-e4 f3-d4 c6-d4 d1-h5 g7-g6 f5-g6 g8-f6 g6-g7 f6-h5 g7-h8 d4-c2 e1-d1 c2-a1 h8-h7 h5-f6 h7-f7 f7-e8'.split(' ') },
                { appliesTo: 'white', name: 'Italian Game - Giuoco Piano', moves: 'e2-e4 e7-e5 g1-f3 b8-c6 f1-c4 f8-c5 d2-d3 g8-f6 b1-c3 e8-g8 h8-f8 c1-g5 d7-d6 c3-d5 h7-h6 d5-f6 g7-f6 g5-h6 f8-e8 f3-h4 f6-f5 c4-f7 g8-f7 d1-h5 f7-g8 h5-g6 g8-h8 g6-g7 g7-h8'.split(' ') },

                { appliesTo: 'white', name: '85% win', moves: 'b1-c3 d7-d5 e2-e4 d5-d4 c3-e2 e7-e5 e2-g3 c7-c5 g1-f3 b8-c6 f1-c4 f8-d6 d2-d3 g8-e7 f3-g5 e8-g8&h8-f8 d1-h5 h7-h6 g5-f7 f8-f7 h5-f7 g8-h7 c1-h6 h7-h6 f7-h5 #'.split(' '), url: 'https://www.youtube.com/watch?v=pogv0YLR7sc' },

                { appliesTo: 'black', name: 'Scandinavian Defense (1)', moves: 'e2-e4 d7-d5 b1-c3 d5-d4 c3-d5 e7-e5 * c7-c6 * c6-d5'.split(' ') },

                { appliesTo: 'black', name: 'Scandinavian Defense (2)', moves: 'e2-e4 d7-d5 e4-d5 g8-f6 c2-c4 e7-e6 d5-e6 c8-e6 d2-d4 f8-b4 b1-c3 f6-e4 c1-d2 d8-d4 g1-f3 d4-f2 #'.split(' '), url: 'http://youtube.com/watch?v=sKoBj-kL0hg', },

                { appliesTo: 'black', name: 'Scandinavian Defense (3)', moves: 'e2-e4 d7-d5 e4-d5 g8-f6 b1-c3 f6-d5 c3-d5 d8-d5 d2-d4 b8-c6 g1-f3 c8-g4 f1-e2 e8-c8&a8-d8 c2-c3 e7-e5 d4-e5 d5-e4 d1-b3 c6-e5 f3-e5 e4-e2'.split(' '), url: 'https://www.youtube.com/watch?v=jEGFEC7qYkM' },

                //https://www.youtube.com/watch?v=bmsjE0ZYUoA&list=PL90OzHiSE_mQcVlOHQ0_niB29icDmDipY
                { appliesTo: 'white', name: 'Bishops Opening Trap (1)', moves: 'e2-e4 e7-e5 f1-c4 g8-f6 b1-c3 f8-c5 d2-d3 d7-d6 f2-f4 f6-g4 f4-f5 g4-f2 d1-h5 e8-g8&h8-f8 c1-g5 d8-e8 c3-d5 f2-h1 d5-f6 g7-f6 g5-f6 * h5-g5 * g5-g7 g7-g8'.split(' ') },
                { appliesTo: 'black', name: 'Bishops Opening Trap (2)', moves: 'e2-e4 e7-e5 f1-c4 g8-f6 d2-d4 e5-d4 e4-e5 d7-d5 c4-b3 f6-e4 g1-e2 f8-c5 f2-f3 d8-h4 g2-g3 d4-d3 g3-h4 c5-f2 e1-f1 c8-h3'.split(' ') },

                { appliesTo: 'black', name: 'Soller Gambit', moves: 'd2-d4 e7-e5 d4-e5 f7-f6 e5-f6 g8-f6 g1-f3 f8-c5 c1-g5 f6-e4 g5-d8 c5-f2 f2-e1'.split(' '), url: 'https://www.youtube.com/watch?v=Uno3DLxDufI' },

                { appliesTo: 'black', name: 'Queens Gambit Declined', moves: 'd2-d4 d7-d5 c2-c4 e7-e6 b1-c3 g8-f6 c1-g5 b8-d7 c4-d5 e6-d5 c3-d5 f6-d5 g5-d8 f8-b4 d1-d2 b4-d2 e1-d2 e8-d8'.split(' '), url: 'https://www.youtube.com/shorts/T3k9otBi9pw', },

                { appliesTo: 'white', name: 'Queens Gambit Declined Trap', moves: 'd2-d4 d7-d5 c2-c4 g8-f6 c4-d5 f6-d5 g1-f3 b8-c6 e2-e4 d5-f6 b1-c3 c8-g4 d4-d5 c6-e5 f3-e5 g4-d1 f1-b5 c7-c6 d5-c6 d8-c7 c6-b7 e8-d8 e5-f7'.split(' '), url: 'https://www.youtube.com/shorts/hxEJvqUgFbU', },

                { appliesTo: 'white', name: 'Alekhines Defense', moves: 'e2-e4 g8-f6 e4-e5 f6-d5 g1-f3 d7-d6 f1-c4 d5-b6 c4-f7 e8-f7 f3-g5 f7-g6 d1-f3 g6-g5 h2-h4 g5-g6 h4-h5 g6-h6 f3-f7 d6-e5 d2-d4 g7-g5 h5-g5&g5-g6 #'.split(' ') },

                { appliesTo: 'white', name: 'Queens Gambit Accepted: Old Variation', moves: 'd2-d4 d7-d5 c2-c4 d5-c4 e2-e3 b7-b5 a2-a4 c7-c6 a4-b5 c6-b5 d1-f3 b8-c6 f3-c6 c8-d7 c6-a6'.split(' ') },

                { appliesTo: 'white', name: 'Missile Gambit', moves: 'g1-f3 d7-d5 e2-e4 d5-e4 f3-g5 g8-f6 d2-d3 e4-d3 f1-d3 h7-h6 g5-f7 e8-f7 d3-g6 f7-g6 d1-d8 b8-c6 d8-c7 e7-e5'.split(' '), url: 'https://www.youtube.com/shorts/P8Iw80W1j78' },
                { appliesTo: 'black', name: 'Queens Gambit Declined: Marshall Gambit', moves: 'd2-d4 e7-e6 e2-e4 d7-d5 b1-c3 c7-c5 g1-f3 b8-c6 e4-d5 e6-d5 f1-e2 g8-f6 e1-g1&h1-f1 f8-e7 c1-g5 e8-g8&h8-f8 d4-c5 c8-e6 f3-d4 e7-c5 d4-e6 f7-e6 e2-g4 d8-d6 g4-h3 a8-e8 d1-d2 c5-b4 g5-f6 f8-f6 a1-d1 d6-c5 d2-e2 b4-c3 b2-c3 c5-c3 d1-d5 c6-d4 e2-h5 e8-f8 d5-e5 f6-h6 h5-g5 h6-h3 e5-c5 c3-g3 h2-g3 d4-e2'.split(' '), url: 'https://www.youtube.com/shorts/Ggr_Zjbj6Ks' },
                { appliesTo: 'white', name: 'Scandinavian Defense: Marshall Gambit Trap', moves: 'e2-e4 b8-c6 d2-d4 d7-d5 e4-d5 d8-d5 b1-c3 d5-d4 d1-e2 c8-g4 f2-f3 g4-h5 c1-e3 d4-b4 e1-c1&a1-d1 a7-a6 c3-d5 b4-a5 e3-b6 c7-b6 d5-c7 * c7-a8'.split(' '), url: 'https://www.youtube.com/shorts/xhX1oFT29gc' },
            ];

            get Selection() { return (localStorage.selection || '').split(',').filter(Boolean); }
            set Selection(selection) { localStorage.selection = selection; this.draw(); }

            set Opening(opening) {
                localStorage.opening = opening;
                this.Selection = [this.Opening?.appliesTo].filter(Boolean);
            }
            get Opening() { return this.database[localStorage.opening] }

            get turn() { return ['black', 'white'][this.Selection.length % 2]; }
            get otherTurn() { return ['black', 'white'].find(c => c !== this.turn) }

            constructor() {
                document.addEventListener('keydown', event => {
                    if (event.key === 'ArrowLeft') this.back();
                    if (event.key === 'ArrowRight') this.next();
                });
                $('#reset').on('click', () => { $('#opening').val('').change(); })
                $('#opening')
                    .html('<option value="">--opening--</option>' + this.database.map((o, i) => `<option value=${i}>${o.appliesTo} : ${o.name}</option>`).join(''))
                    .on('change', ({ target }) => { this.Opening = target.value; $(target).blur() })
                    .val(this.database.indexOf(this.Opening));
                this.draw();
            }

            back() {
                if (this.Selection.length > 1) {
                    this.moveSpeed = 1;
                    this.Selection = this.Selection.slice(0, this.Selection.length - 1);
                    delete this.moveSpeed;
                }
            }

            next(choice) {
                choice ||= this.Opening?.moves.at(this.Selection.length - 1);
                if (choice && choice !== this.Selection.at(-1) && (!this.Opening || this.Selection.length < this.Opening.moves.length)) {
                    this.Selection = [...this.Selection, choice];
                }
            }

            draw() {
                // clearInterval(this.interval);
                // this.interval = setInterval(() => this.draw(), 3000);
                const { moveSpeed } = this;
                const moves = [...this.Selection];
                const database = [...this.database].sort((a, b) => b.moves.length - a.moves.length)
                const orientation = moves.shift();
                const openings = this.Opening && [this.Opening]
                    || !orientation && ['black', 'white'].map(appliesTo => ({ appliesTo, moves: [] }))
                    || database
                        .filter(opening => !orientation || opening.appliesTo.includes(orientation))
                        .filter(opening => moves.every((move, index) => opening.moves[index] == move));

                $('#boards').html('');
                $('#moves').html(this.Selection.map(move => `<a href="javascript:void(0)">${move}</a>`).join(' / '))
                $('#moves').children().each((index, child) => {
                    $(child).on('click', () => {
                        this.Selection = this.Selection.slice(0, Math.max(this.Opening ? 1 : index, index));
                    });
                });

                // show the next move for every opening that matches the line we have played so far
                for (var opening of openings) {
                    const common = !this.Selection.length
                        ? database.filter(o => o.appliesTo === opening.appliesTo)
                        : openings.filter(o => o.moves[moves.length] == opening.moves[moves.length]);
                    const titles = [...new Set(common.map(o => o.name))];
                    const title = titles.join(', ');
                    const index = common.indexOf(opening);
                    const orientation = opening.appliesTo;
                    const final = opening.moves.length === moves.length && 'red';
                    const secondLast = opening.moves.length === moves.length + 1 && 'green';
                    const nextMove = opening.moves.length === 0 && orientation
                        || opening.moves[moves.length]
                        || opening.moves[moves.length - 1];
                    const domove = (board, move, islast) => {
                        const moves = move.split('&').filter(Boolean);
                        for (const m of moves) {
                            if (m === '#') { // signifies checkmate
                                const turn = moves.length == 1 ? this.turn : this.otherTurn;
                                const position = board.position();
                                const kingPosition = Object.keys(position).find(square => position[square] === `${turn[0]}K`);
                                delete position[kingPosition];
                                board.position(position);
                            } else if (m === '*') { // signifies any piece can move -- visualized by hiding all color's pieces
                                const position = board.position();
                                if (!islast) {
                                    for (const [k, v] of [...Object.entries(position)])
                                        if (v.startsWith(this.turn.at(0)))
                                            delete position[k];
                                    board.position(position);
                                }
                            } else
                                board.move(m);
                        }
                    };

                    if (index > 0 && opening.moves.length) continue;

                    $('#moves a').eq(opening.moves.length).css('color', 'red');
                    $('#moves a').eq(opening.moves.length - 1).css('color', 'green');
                    $('#boards').append(`<div style="width: 400px;"> <div class="board"></div> <div class="next"></div> <div class="title"> </div> </div> `);
                    $('#boards .title').last().html(title);
                    $('#boards .next').last().html(nextMove);

                    const $board = $('#boards .board').last();

                    // we create one temporary chessboard to plot each, without animation, to get the position, 
                    const position = (() => {
                        const board1 = Chessboard($board, { position: 'start', moveSpeed: 0, orientation });
                        for (const move of moves) domove(board1, move, move == moves.at(-1));
                        const position = board1.position();
                        board1.destroy();
                        return position;
                    })();

                    const board = Chessboard($board, {
                        position,
                        draggable: nextMove !== '#' && !this.Opening,
                        moveSpeed,
                        orientation,
                        // let the user extend the opening with a new move -- copying the change to the clipboard for it to be pasted and hard-coded...
                        onDrop: (source, target, piece, newPos, oldPos, orientation) => {
                            const checkmate = target == 'offboard' && piece.endsWith('K') && '#';
                            const valid = target !== 'offboard' || checkmate;
                            if (source == target) {
                                if (!secondLast) this.next(nextMove);
                            } else if (valid) {
                                const move = checkmate || [source, target].join('-');
                                const newOpening = this.Selection.length === 0;

                                if (!final || newOpening) {
                                    this.database.push(opening = JSON.parse(JSON.stringify(opening)));
                                    opening.moves.splice(this.Selection.length - 1);
                                    opening.name += ' ( clone )';
                                }

                                opening.moves = this.Selection.slice(1);

                                if (nextMove && !newOpening && !final) opening.moves.push(nextMove);

                                const samecolor = !newOpening && piece[0] === board.position()[(nextMove || opening.moves.at(-1)).split('-').at(-1)][0];

                                if (samecolor) opening.moves[opening.moves.length - 1] += '&' + move;

                                else opening.moves.push(move);

                                this.Selection = [orientation, ...opening.moves];

                                navigator.clipboard.writeText(opening.moves.join(' '));//JSON.stringify(opening) + '\n' + 
                            }
                        }
                    });

                    domove(board, nextMove);

                    console.log(nextMove);

                    if (nextMove && !secondLast) $board.on('click', () => { this.next(nextMove); });
                }
            }
        }
    </script>
</body>

</html>